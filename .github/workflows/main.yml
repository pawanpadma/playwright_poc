name: Playwright Tests with Test Case Matrix

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_file: [
          "tests/home.spec.ts",
          "tests/mydemo.spec.ts,
         
          ]
        # You can combine with browsers if needed:
        # browser: [chromium, firefox]
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install
    
    - name: Run specific test group
      run: |
        # Run only tests matching the current group
        npx playwright test \
          --grep "${{ matrix.test_group }}" \
          --reporter=html
      env:
        PLAYWRIGHT_HTML_REPORT: playwright-report-${{ matrix.test_group }}
    
    - name: Rename HTML report directory
      run: mv playwright-report $PLAYWRIGHT_HTML_REPORT
    
    - name: Upload HTML report artifact
      uses: actions/upload-artifact@v4
      with:
        name: html-report-${{ matrix.test_group }}
        path: ${{ env.PLAYWRIGHT_HTML_REPORT }}
        retention-days: 1

  merge-reports:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Install dependencies
      run: npm ci
    
    - name: Download all report artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-reports
        pattern: html-report-*
        merge-multiple: true
    
    - name: Merge HTML reports
      run: |
        # Install the merge tool
        npm install -g playwright-merge-html-reports
        # Merge all reports
        playwright-merge-html-reports --input all-reports --output merged-report
    
    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: merged-html-report
        path: merged-report
        retention-days: 7
