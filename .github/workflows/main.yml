name: Playwright Tests with Test Case Matrix

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  PROJECT_DIR: playwright_automation

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test_file:  ["tests/mydemo.spec.ts","tests/home.spec.ts"]
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify directory structure
      run: |
        echo "Working directory: $(pwd)"
        ls -la
        echo "Project contents:"
        ls -la ${{ env.PROJECT_DIR }}/
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Install dependencies
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        # Generate lockfile if missing
        if [ ! -f package-lock.json ]; then
          npm install --package-lock-only
        fi
        # Clean install
        npm install
      
    - name: Install Playwright browsers
      working-directory: ${{ env.PROJECT_DIR }}
      run: npx playwright install
    - name: Install Chrome for Testing
      run: |
        npx playwright install chrome
        npx playwright install-deps
    - name: Run specific test group
      working-directory: ${{ env.PROJECT_DIR }}
      run: npx playwright test --grep "@${{ matrix.test_group }}" --reporter=html
      env:
        PLAYWRIGHT_HTML_REPORT: playwright-report-${{ matrix.test_group }}
    
    - name: Prepare report for upload
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        mv playwright-report $PLAYWRIGHT_HTML_REPORT || true
        mkdir -p ../artifacts
        cp -r $PLAYWRIGHT_HTML_REPORT ../artifacts/
    
    - name: Upload HTML report artifact
      uses: actions/upload-artifact@v4
      with:
        name: html-report-${{ matrix.test_group }}
        path: artifacts/$PLAYWRIGHT_HTML_REPORT
        retention-days: 1

  merge-reports:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
    
    - name: Download all report artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: html-report-*
        merge-multiple: true
    
    - name: Merge HTML reports
      run: |
        npm install -g playwright-merge-html-reports
        playwright-merge-html-reports --input artifacts --output merged-report
    
    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: merged-html-report
        path: merged-report
        retention-days: 7
